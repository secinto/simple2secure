version: '3.1'

services:
    s2s-portal:
        build:
            context: .
            dockerfile: simple2secure.portal/Dockerfile
        container_name: s2s-portal
        ports:
            - 51000:8080
            - 51001:8443
        volumes:
            - ./ssl:/usr/local/tomcat/ssl
            - ./server.xml:/usr/local/tomcat/conf/server.xml
            - ./web.xml:/usr/local/tomcat/conf/web.xml
        depends_on:
            - mongodb
        working_dir: /opt/app
                
    mongodb:
        image: mongo
        container_name: s2s-mongodb
        hostname: localhost
        volumes:
            - $HOME/mongo/data/db:/data/db
        restart: always
        
    s2s-web:  
        build: ./simple2secure.web/.
        container_name: s2s-web
        network_mode: bridge
        ports: 
            - 51002:80
            - 51003:443
        depends_on:
            - s2s-portal
        volumes:
            - ./data/certbot/conf:/etc/letsencrypt
            - ./data/certbot/www:/var/www/certbot
        command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
    certbot:
        image: certbot/certbot
        entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
        volumes:
            - ./data/certbot/conf:/etc/letsencrypt
            - ./data/certbot/www:/var/www/certbot